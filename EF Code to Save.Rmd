---
title: "R Notebook"
output: html_notebook
---


Getting a list of data frames using station metadata:
```{r}

#metadata subset - list of df
stations_subset_metadata <- list()
for (st in stations_subset) {data <- tidyhydat::hy_stn_data_coll(station_number = (st))
stations_subset_metadata[[st]] <- data.frame(data)
}
#this worked, can get a metadata list of lists.

```



##HOW TO MAKE STATION NUMBERS INTO A LIST - WHILE REMOVING NAS

```{r}

#Post-dam stations- get rid of blanks and make into a list

#select only the list of pre-dam station numbers
postdam_stations <- stations_to_analyze %>%
select(post.dam..1969.1989)


#delete rows that are na or blanks
postdam_stations <- postdam_stations[!(is.na(postdam_stations$post.dam..1969.1989) | postdam_stations$post.dam..1969.1989==""), ]

#make as a list of characters
as.list(as.character(postdam_stations))

#use this variable in the tidyhat package for station_number =
```


##COMPARE TWO LISTS OF STN NUMBERS TO SEE IF ANY ARE IN COMMON
```{r}

unique(postdam_stations[postdam_stations %in% predam_stations])

```

##HOW TO EXTRACT DATA INTO A LIST OF DF USING TRYCATCH SO IT CONTINUES TO EXTRACT DATA EVEN IF STN NUMBER IS NULL

```{r}

#Flow only with trycatch #this worked
dfFlow_subset <- list()
for (st in stations_subset) {data <- tryCatch(tidyhydat::hy_daily_flows(station_number = (st)), error = function(e) NULL)
if (!is.null(data)){
dfFlow_subset[[st]] <- data.frame(data) 
}
}

```

## checking that the above worked ##

```{r}

for (df in dfFlow_subset) {
  print(unique(df$STATION_NUMBER, df$Parameter))
  print(unique(df$Parameter)) 
}
#it worked, outputs only flow parameters

```

#This is code for getting flow and water level data for all stations and putting it into a list of dataframes. 
```{r}

dfList <- list()
for (st in stations_all) {data <- tidyhydat::hy_daily(station_number = (st))
dfList[[st]] <- data.frame(data)
}

```


7) Goal: list of df with flow_cont, flow_seas, level_cont, level_seas with "B" or "not B"

```{r}

First separate by B vs not B - see code below for this
Separate the flow and water level data for the stations that have ice ("open water" data) and do not have ice ("year round" data)
(cont from step 5)

```{r}
#waiting to have seas/cont data
open_water = list()
year_round = list()

for (df in dfList) {
  if("B" %in% df$Symbol) {
    open_water = append(open_water, df)
  } else {
    year_round = append(year_round, df)
  }  }


```


 QA/QC checks on the open water and ice data to make sure they are correctly separated
```{r}
#skip this step for now, use metadata for B

for (df in open_water) {
  if ("B" %in% df$Symbol){
    print("Open water data are correct")
  } else {
    print("Open water data are incorrectly separated, there are stations with Ice")
  }
}
#add exception for no df in list
```


```{r}

for (df in open_water) {
  if ("B" !%in% df$Symbol){
    print("Open water data are correct")
  } else {
    print("Open water data are incorrectly separated, there are stations with Ice")
  }
}
#add exception for no df in list

```

8) Try to find how many consecutive Nas there are in a row and flag somehow
```{r}
#use flow only data and level only data

for (df in dfFlow_subset) {
  if (length(is.na(df$Value)) >= 14.0) {
    print("There are 14 or more NAs in a row for these dates: ")
} else {
    print("there are not 14 or more NAs in a row") #need to mutate a new column with "flagged"
  } }

#x = is.na(dfList_subset$'07DA045'$Value)
#rle(x)$lengths[rle(x)$values]
```

##TRYING TO FIND CONSEC NAs

```{r}

consecnas <- function(x, n=14) {
  y = rle(is.na(x))
          y$Values <- y$lengths > (n- 0.5) & y$values
          inverse.rle(y)
}

mindex <- apply(flow_subset_onelist, 2, consecna)

```



```{r}
flow_subset_onelist[max(with(rle(is.na(x)), lengths[values])), by = Symbol]

```


```{r}
#flowsubet one list

is.na.rle <- rle(is.na(flow_subset_onelist[,1]))
is.na.rle$Values <- is.na.rle$Values & is.na.rle$lengths >= 14
flow_subset_onelist[!inverse.rle(is.na.rle),]



```


```{r}

find_consec_nas <- function(df) {
  nas <- is.na(df$Value)
  rle_nas = fle(nas)
  
  df$flag_col <-ifelse(rle_nas$Value[rle_nas$lengths >= 14],
                       "more than 14", "less than 14")
                       return(df)
}

dfLevel_subset <- lapply(dfLevel_subset, find_consec_nas)


```




```{r}
dfList <- list()
for (st in stations_all) {data <- tidyhydat::hy_daily(station_number = (st))
dfList[[st]] <- data.frame(data)
}

```


```{r}

open_water = list()
year_round = list()

for (df in dfList) {
  if("B" %in% df$Symbol) {
    open_water = append(open_water, df)
  } else {
    year_round = append(year_round, df)
  }  }


```

```{r}


```


```


```{r}

```
```

