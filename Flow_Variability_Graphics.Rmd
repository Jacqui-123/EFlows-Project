
## Data Visualization for stations on the PAD


```{r}

library(png)
library(reticulate)
library(IHA)
library(tidyverse)
library(tidyhydat)
library(zoo)
library(lubridate)
library(ggplot2)

```


```{r}

pr_stn <- tidyhydat::hy_daily_flows(station_number = "07HA001")

```


```{r}

predam_flow <- function(df,Date, Value) {
library(dplyr)
df <- df %>%
  select(Date, Value) %>%
  na.omit()%>%
  filter( Date >= "1915-10-01" & Date < "1931-10-01") %>% 
  mutate(Date = format(Date,"%d-%m-%Y"))
  return(df)
}

postdam_flow <- function(df,Date, Value) {
library(dplyr)
df <- df %>%
  select(Date, Value) %>%
  na.omit() %>%
  filter(Date >= "1972-10-01" & Date < "1992-10-01") %>%
  mutate(Date = format(Date,"%d-%m-%Y"))
  return(df)
}

```

```{r}

pr_stn_pre <- predam_flow(pr_stn, Date, Value)
pr_stn_post <- postdam_flow(pr_stn, Date, Value)

```

Predam IHA Variables 
```{r}

flow_data <- zoo(pr_stn_pre$Value, order.by = as.Date(as.character(pr_stn_pre$Date), format = "%d-%m-%Y"))

## Run IHA analyses
group1_output <- group1(flow_data, year = "water", FUN = median)
group2_output <- group2(flow_data, year = "water", mimic.tnc = TRUE)
group3_output <- group3(flow_data, year = "water", mimic.tnc = FALSE)
group4_output <- group4(flow_data, year = "water")
group5_output <- group5(flow_data, year = "water")

## Convert outputs
group1_output <- as.data.frame(group1_output)
group2_output <- group2_output[,-1]
group3_output <- as.data.frame(group3_output)
group4_output <- as.data.frame(group4_output)
group5_output <- as.data.frame(group5_output)

## Create output dataframe 
IHA_output <- bind_cols(list(group1_output, group2_output, group3_output, group4_output, group5_output))

#adding a row of post-dam years to be able to graph this on the same plot in ggplot
#adding a "time period" grouping in case these are joined later
library(tibble)
IHA_output_pre <- tibble::rownames_to_column(IHA_output, "Year") %>%
 #add_row(Year = c("1968", "1967") )%>%
 add_column(Time_Period = "Pre Dam" )  %>%
  add_column('post_years'= c(1973, 1974, 1975, 1976, 1977, 1978, 1979, 1980, 1981, 1982, 1983, 1984, 1985, 1986, 1987, 1989)) %>%
mutate(post_years = as.character(post_years))


```

Postdam IHA Variables 

```{r}

flow_data <- zoo(pr_stn_post$Value, order.by = as.Date(as.character(pr_stn_post$Date), format = "%d-%m-%Y"))

## Run IHA analyses
group1_output <- group1(flow_data, year = "water", FUN = median)
group2_output <- group2(flow_data, year = "water", mimic.tnc = TRUE)
group3_output <- group3(flow_data, year = "water", mimic.tnc = FALSE)
group4_output <- group4(flow_data, year = "water")
group5_output <- group5(flow_data, year = "water")

## Convert outputs
group1_output <- as.data.frame(group1_output)
group2_output <- group2_output[,-1]
group3_output <- as.data.frame(group3_output)
group4_output <- as.data.frame(group4_output)
group5_output <- as.data.frame(group5_output)

## Create output dataframe 
IHA_output <- bind_cols(list(group1_output, group2_output, group3_output, group4_output, group5_output))

library(tibble)

IHA_output_post <- tibble::rownames_to_column(IHA_output, "Year") %>%
 # add_row(Year = c("1968", "1967") )%>%
 add_column(Time_Period = "Post Dam" )

```

Line graphs -  Max flow predam vs post dam
```{r}

ggplot() +
  geom_line(data = IHA_output_post, aes(x =Year, y = Max, group = 1), colour = "red", size = 0.75)  + 
      geom_point() + 
  annotate(geom="text", x=16, y=250, label="Maximum flow, post-dam, 1973-1992",
              color="red") +
  
  #geom_line(data = IHA_output_post, aes(x =Year, y = Min, group = 1), colour = "blue" ) + 
   #   geom_point() + 
  
  geom_line(data = IHA_output_pre, aes(x = post_years, y = Max, group = 1), colour = "black", size = 1)  + 
      geom_point() +
  annotate(geom="text", x=14, y=140, label="Maximum flow, pre-dam: 1916-1931",
              color="black") +

  ggtitle( "Maximum River Flow Pre and Post Bennet Dam for a Station on the Peace River") +
  ylab("Flow")+
  xlab("Post-dam years") +
  theme_bw() +
   theme(plot.title = element_text(size = 10, hjust = .5, face = "bold")) # +
    #theme(axis.text.x = element_blank()) #+

  
    # theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  #  theme(legend.background = element_rect(colour = 'black', fill = 'white', linetype='solid')) +
#  theme(legend.position=c(0.87, 0.8), legend.title=element_text(size=8), legend.text=element_text(size=7)) +
#   scale_colour_discrete(na.translate = F)
```

Calculate percentiles, to get a range of variability within 0.33, 0.64 percentiles: 

```{r}
#function to calculate both quartiles, 0.33, 0.63, in one df
quant_calc <- function(x) {

quantiles <- quantile(x, c(0.33, 0.64))
names(quantiles) <- paste0(names(x), "_quantile")
return(quantiles)
}
#not as good for data tidying, otherwise need to manually rename columns
```

Calculate quartiles, rename columns, and then join dfs together:
```{r}

#functions to calculate each quartiles, 0.33, 0.63, in separate dfs

quant_calc_33 <- function(x){
  quant <- quantile(x, c(0.33))
  return(quant)
}

quant_calc_64 <- function(x){
  quant <- quantile(x, c(0.64))
  return(quant)
}

#function to rename column, use after calc quartiles 
rename_cols <- function(df, suffix) {
  names(df) <- paste0(names(df), suffix)
  return(df)
}
```

Rename columns and join 0.33 and 0.64 dfs together 
```{r}

name <- names(pre_33)

pre_33 <- IHA_output_pre %>%
  select(-c("Low pulse length")) %>%
  summarise(across(October:Reversals, quant_calc_33)) %>%
  rename_cols("_q33") %>%
  add_row(.before = 2, .rows = 18) %>%
  fill(name) %>% 
add_column('post_years'= c(1973, 1974, 1975, 1976, 1977, 1978, 1979, 1980, 1981, 1982, 1983, 1984, 1985, 1986, 1987, 1989, 1990, 1991, 1992))

name <- names(pre_64)
pre_64 <- IHA_output_pre %>%
  select(-c("Low pulse length")) %>%
  summarise(across(October:Reversals, quant_calc_64)) %>%
  rename_cols("_q64") %>%
  add_row(.before = 2, .rows = 18) %>% 
  fill(name) %>%
add_column('post_years'= c(1973, 1974, 1975, 1976, 1977, 1978, 1979, 1980, 1981, 1982, 1983, 1984, 1985, 1986, 1987, 1989, 1990, 1991, 1992))
  
#join together 
df_quartiles <- merge(pre_33, pre_64, by = "post_years" ) %>%
mutate(post_years = as.character(post_years))

```

Finally, graph an IHA variable for the post-dam period with the 0.33-0.64 percentiles from the pre-dam period 
```{r}
ggplot() +
  geom_line(data = IHA_output_post, aes(x =Year, y = Max, group = 1), colour = "red", size = 0.75)  + 
      geom_point() + 
   annotate(geom="text", x=16, y=250, label="Maximum flow, post-dam, 1973-1992",
              color="red") +
 #q33 line
  geom_line(data = df_quartiles, aes(x = post_years, y = Max_q33, group = 1), linetype = 'dotted', colour = "black", size = 0.5)  + 
  #q64 line
  geom_line(data = df_quartiles, aes(x = post_years, y = Max_q64, group = 1), linetype = 'dotted', colour = "black", size = 0.5)  

#maybe also add a .50 median line?
```
Now, switching gears to calculate percent change 

```{r}
#to look at the distribution of the data
#ggplot(IHA_output_post, aes( x = March)) + 
 # geom_histogram(binwidth = 100)
#seems uneven, should we use median instead?

#mean for all values, predam
IHA_output_pre_mean <- IHA_output_pre %>%
  summarise(across(October:Reversals, mean)) 

#mean for all values, postdam
IHA_output_post_mean <- IHA_output_post %>%
  summarise(across(October:Reversals, mean)) 

```

```{r}
#percent change pre and post dam
m <-  ((IHA_output_post_mean - IHA_output_pre_mean)/IHA_output_pre_mean) * 100

```

Graphs of mean percent change
```{r}

#reshape percent change df 
test <- data.frame(t(m)) %>%
  rename("Value" =  "t.m." ) %>%
  rownames_to_column("Variable")

#us this to round in case want to label bars
test$Value <- round (test$Value, digits = 0)

#barplot of mins and maxes percent change
ggplot(test, aes( x = Variable, y = Value) ) +
  geom_col() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  ylab("Percent change") +
  xlab("IHA variable") +
  scale_x_discrete(limits = c('1 Day Min', '3 Day Min', '7 Day Min','30 Day Min', '90 Day Min', '1 Day Max', '3 Day Max', '7 Day Max', '30 Day Max' , '90 Day Max')) #+

  #geom_text(aes(label = Value), vjust = 1)

```

```{r}

#barplot of percent change by month

ggplot(test, aes( x = Variable, y = Value) ) +
  geom_col() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  ylab("Percent change") +
  xlab("IHA variable") +
scale_x_discrete(limits = c('October', 'November', 'December', 'January' , 'February', 'March', 'April', 'May', 'June','July', 'August', 'September'))

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

